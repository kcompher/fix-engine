<p>This section contains verification goals for Hearbeat messages.</p>
<h3 id="heartbeat-vg1">Heartbeat VG.1</h3>
<p>“When either end of a FIX connection has not sent any data for [HeartBtInt] seconds, it will transmit a Heartbeat message.”</p>

<p>Notes: we transform this statement into 2 VGs:</p>
<ul>
  <li>VG.1.1 - any outbound message will result in an updated <code class="highlighter-rouge">fe_last_time_data_sent</code> field</li>
  <li>VG.1.2 - any time update will result in check whether <code class="highlighter-rouge">Heartbeat</code> should be sent out</li>
</ul>

<figure class="highlight"><pre><code class="language-iml" data-lang="iml"><span class="kr">verify</span> <span class="n">last_time_data_sent_gets_updated</span> <span class="p">(</span> <span class="n">engine</span> <span class="o">:</span> <span class="n">fix_engine_state</span> <span class="p">)</span> <span class="o">=</span>
 <span class="k">let</span> <span class="n">engine'</span> <span class="o">=</span> <span class="n">one_step</span> <span class="p">(</span> <span class="n">engine</span> <span class="p">)</span> <span class="k">in</span>
 <span class="p">(</span> <span class="n">engine</span><span class="o">.</span><span class="n">outgoing_fix_msg</span> <span class="o">=</span> <span class="nc">None</span> <span class="o">&amp;&amp;</span> <span class="n">engine'</span><span class="o">.</span><span class="n">outgoing_fix_msg</span> <span class="o">&lt;&gt;</span> <span class="nc">None</span> <span class="p">)</span>
  <span class="o">==&gt;</span> <span class="p">(</span><span class="n">engine'</span><span class="o">.</span><span class="n">fe_last_time_data_sent</span> <span class="o">=</span> <span class="n">engine'</span><span class="o">.</span><span class="n">fe_curr_time</span> <span class="p">)</span>
<span class="p">;;</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-iml" data-lang="iml"><span class="k">let</span> <span class="n">outbound_msg_heartbeat</span> <span class="p">(</span> <span class="n">m</span> <span class="o">:</span> <span class="n">full_top_level_msg</span> <span class="n">option</span> <span class="p">)</span><span class="o">=</span>
 <span class="k">match</span> <span class="n">m</span> <span class="k">with</span> 
 <span class="o">|</span> <span class="nc">None</span>  <span class="o">-&gt;</span> <span class="bp">false</span>
 <span class="o">|</span> <span class="nc">Some</span> <span class="n">msg</span>  <span class="o">-&gt;</span>
 <span class="k">match</span> <span class="n">msg</span> <span class="k">with</span>
 <span class="o">|</span> <span class="nc">ValidMsg</span> <span class="n">vmsg</span> <span class="o">-&gt;</span> <span class="p">(</span>
  <span class="k">match</span> <span class="n">vmsg</span><span class="o">.</span><span class="n">full_msg_data</span> <span class="k">with</span> 
  <span class="o">|</span> <span class="nc">Full_FIX_Admin_Msg</span> <span class="n">admin_msg</span>  <span class="o">-&gt;</span> <span class="p">(</span>
   <span class="k">match</span> <span class="n">admin_msg</span> <span class="k">with</span> 
   <span class="o">|</span> <span class="nc">Full_Msg_Hearbeat</span> <span class="n">_</span>       <span class="o">-&gt;</span> <span class="bp">true</span>
   <span class="o">|</span> <span class="nc">Full_Msg_Test_Request</span> <span class="n">_</span>   <span class="o">-&gt;</span> <span class="bp">true</span>
   <span class="o">|</span> <span class="n">_</span>                         <span class="o">-&gt;</span> <span class="bp">false</span>
   <span class="p">)</span>
  <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="bp">false</span>
  <span class="p">)</span>
 <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="bp">false</span>
<span class="p">;;</span>

<span class="k">let</span> <span class="n">time_update_received</span> <span class="p">(</span> <span class="n">m</span><span class="o">,</span> <span class="n">last_time_data_sent</span><span class="o">,</span> <span class="n">hbeat_interval</span> <span class="o">:</span> <span class="n">fix_engine_int_msg</span> <span class="n">option</span> <span class="o">*</span> <span class="n">fix_utctimestamp</span> <span class="o">*</span> <span class="n">fix_duration</span> <span class="p">)</span> <span class="o">=</span>
 <span class="k">match</span> <span class="n">m</span> <span class="k">with</span>
 <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="bp">false</span>
 <span class="o">|</span> <span class="nc">Some</span> <span class="n">mint</span> <span class="o">-&gt;</span> 
 <span class="k">match</span> <span class="n">mint</span> <span class="k">with</span> 
 <span class="o">|</span> <span class="nc">TimeChange</span> <span class="n">tc_data</span> <span class="o">-&gt;</span> 
  <span class="k">let</span> <span class="n">valid_time</span> <span class="o">=</span> <span class="n">utctimestamp_add</span> <span class="p">(</span> <span class="n">last_time_data_sent</span><span class="o">,</span> <span class="n">hbeat_interval</span> <span class="p">)</span> <span class="k">in</span>
  <span class="n">utctimestamp_greaterThan</span> <span class="p">(</span> <span class="n">tc_data</span><span class="o">,</span> <span class="n">valid_time</span> <span class="p">)</span>
 <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="bp">false</span>
<span class="p">;;</span>

<span class="kr">verify</span> <span class="n">hbeat_sent_if_no_data_received</span> <span class="p">(</span> <span class="n">engine</span> <span class="o">:</span> <span class="n">fix_engine_state</span> <span class="p">)</span> <span class="o">=</span>
 <span class="k">let</span> <span class="n">engine'</span> <span class="o">=</span> <span class="n">one_step</span> <span class="p">(</span> <span class="n">engine</span> <span class="p">)</span> <span class="k">in</span> <span class="p">(</span> 
 <span class="n">engine</span><span class="o">.</span><span class="n">fe_curr_mode</span> <span class="o">=</span> <span class="nc">ActiveSession</span> <span class="o">&amp;&amp;</span> 
 <span class="n">is_int_message_valid</span> <span class="p">(</span> <span class="n">engine</span><span class="p">)</span> <span class="o">&amp;&amp;</span> 
 <span class="n">is_state_valid</span> <span class="p">(</span> <span class="n">engine</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> 
 <span class="n">time_update_received</span> <span class="p">(</span> <span class="n">engine</span><span class="o">.</span><span class="n">incoming_int_msg</span><span class="o">,</span> <span class="n">engine</span><span class="o">.</span><span class="n">fe_last_time_data_sent</span><span class="o">,</span> <span class="n">engine</span><span class="o">.</span><span class="n">fe_heartbeat_interval</span> <span class="p">)</span> <span class="p">)</span>
 <span class="o">==&gt;</span> <span class="n">outbound_msg_heartbeat</span> <span class="p">(</span> <span class="n">engine'</span><span class="o">.</span><span class="n">outgoing_fix_msg</span> <span class="p">)</span>
<span class="p">;;</span></code></pre></figure>

<h3 id="heartbeat-vg2">Heartbeat VG.2</h3>

<p>Notes: there’s no mention of what constitutes a successful data - i.e. is it a non-garbled (but still rejected message)? We interpret this here as that a Non-garbled message results in update of data received.</p>

<p>Also, it’s important to note that we would not process an incoming message if the engine is in a Retransmit or CacheReplay mode, hence we use <code class="highlighter-rouge">let incoming_processed = engine.incoming_fix_msg &lt;&gt; engine'.incoming_fix_msg</code></p>

<figure class="highlight"><pre><code class="language-iml" data-lang="iml"><span class="k">let</span> <span class="n">incoming_is_not_garbled</span> <span class="p">(</span> <span class="n">m</span> <span class="o">:</span> <span class="n">full_top_level_msg</span> <span class="n">option</span> <span class="p">)</span> <span class="o">=</span> 
 <span class="k">match</span> <span class="n">m</span> <span class="k">with</span> 
 <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="bp">false</span>
 <span class="o">|</span> <span class="nc">Some</span> <span class="n">msg</span> <span class="o">-&gt;</span>
 <span class="k">match</span> <span class="n">msg</span> <span class="k">with</span>
 <span class="o">|</span> <span class="nc">Garbled</span> <span class="o">-&gt;</span> <span class="bp">false</span>
 <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="bp">true</span>
<span class="p">;;</span>

<span class="kr">verify</span> <span class="n">non_garbled_updates_clock</span> <span class="p">(</span> <span class="n">engine</span> <span class="o">:</span> <span class="n">fix_engine_state</span> <span class="p">)</span> <span class="o">=</span>
 <span class="k">let</span> <span class="n">engine'</span> <span class="o">=</span> <span class="n">one_step</span> <span class="p">(</span><span class="n">engine</span><span class="p">)</span> <span class="k">in</span> 
 <span class="k">let</span> <span class="n">received_ts_correct</span> <span class="o">=</span>  <span class="p">(</span> <span class="n">engine</span><span class="o">.</span><span class="n">fe_curr_time</span> <span class="o">=</span> <span class="n">engine'</span><span class="o">.</span><span class="n">fe_last_data_received</span> <span class="p">)</span> <span class="k">in</span> 
 <span class="k">let</span> <span class="n">incoming_processed</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">incoming_fix_msg</span> <span class="o">&lt;&gt;</span> <span class="n">engine'</span><span class="o">.</span><span class="n">incoming_fix_msg</span> <span class="k">in</span> 
 <span class="p">(</span> <span class="n">incoming_is_not_garbled</span> <span class="p">(</span> <span class="n">engine</span><span class="o">.</span><span class="n">incoming_fix_msg</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">incoming_processed</span><span class="p">)</span> <span class="o">==&gt;</span> <span class="n">received_ts_correct</span>
<span class="p">;;</span></code></pre></figure>

<h3 id="heartbeat-vg3">Heartbeat VG.3</h3>

<p>‘When either end of the connection has not received any data for (<code class="highlighter-rouge">HeartBtInt</code> + “some reasonable transmission time”) seconds, it will transmit a Test Request message.’</p>

<p>Notes: ‘reasonable time’ is represented by a ‘duration’ type field <code class="highlighter-rouge">fe_testreq_interval</code>.</p>

<figure class="highlight"><pre><code class="language-iml" data-lang="iml"><span class="k">let</span> <span class="n">no_heartbeats_received</span> <span class="p">(</span> <span class="n">m</span><span class="o">,</span> <span class="n">data_received</span><span class="o">,</span> <span class="n">hbeat_interval</span><span class="o">,</span> <span class="n">pad_interval</span> <span class="o">:</span> <span class="n">fix_engine_int_msg</span> <span class="n">option</span> <span class="o">*</span> <span class="n">fix_utctimestamp</span> <span class="o">*</span> <span class="n">fix_duration</span> <span class="o">*</span> <span class="n">fix_duration</span> <span class="p">)</span> <span class="o">=</span>
 <span class="k">match</span> <span class="n">m</span> <span class="k">with</span>
 <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="bp">false</span>
 <span class="o">|</span> <span class="nc">Some</span> <span class="n">mint</span> <span class="o">-&gt;</span> 
 <span class="k">match</span> <span class="n">mint</span> <span class="k">with</span> 
 <span class="o">|</span> <span class="nc">TimeChange</span> <span class="n">tc_data</span> <span class="o">-&gt;</span> 
  <span class="k">let</span> <span class="n">valid_time</span> <span class="o">=</span> <span class="n">utctimestamp_add</span> <span class="p">(</span> <span class="n">data_received</span><span class="o">,</span> <span class="n">hbeat_interval</span> <span class="p">)</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">valid_time_padded</span> <span class="o">=</span> <span class="n">utctimestamp_add</span> <span class="p">(</span> <span class="n">valid_time</span><span class="o">,</span> <span class="n">pad_interval</span> <span class="p">)</span> <span class="k">in</span>
  <span class="n">utctimestamp_greaterThan</span> <span class="p">(</span> <span class="n">tc_data</span><span class="o">,</span> <span class="n">valid_time_padded</span> <span class="p">)</span>
 <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="bp">false</span>
<span class="p">;;</span>

<span class="k">let</span> <span class="n">msg_is_test_request</span> <span class="p">(</span> <span class="n">m</span> <span class="o">:</span> <span class="n">full_top_level_msg</span> <span class="n">option</span> <span class="p">)</span> <span class="o">=</span>
 <span class="k">match</span> <span class="n">m</span> <span class="k">with</span> 
 <span class="o">|</span> <span class="nc">None</span>  <span class="o">-&gt;</span> <span class="bp">false</span>
 <span class="o">|</span> <span class="nc">Some</span> <span class="n">msg</span> <span class="o">-&gt;</span>
 <span class="k">match</span> <span class="n">msg</span> <span class="k">with</span>
 <span class="o">|</span> <span class="nc">ValidMsg</span> <span class="n">vmsg</span> <span class="o">-&gt;</span> <span class="p">(</span>
  <span class="k">match</span> <span class="n">vmsg</span><span class="o">.</span><span class="n">full_msg_data</span> <span class="k">with</span> 
  <span class="o">|</span> <span class="nc">Full_FIX_Admin_Msg</span> <span class="n">admin_msg</span>  <span class="o">-&gt;</span> <span class="p">(</span>
   <span class="k">match</span> <span class="n">admin_msg</span> <span class="k">with</span> 
   <span class="o">|</span> <span class="nc">Full_Msg_Test_Request</span> <span class="n">_</span>  <span class="o">-&gt;</span> <span class="bp">true</span>
   <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="bp">false</span>
  <span class="p">)</span>
  <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="bp">false</span>
 <span class="p">)</span>
 <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="bp">false</span>
<span class="p">;;</span>

<span class="kr">verify</span> <span class="n">test_request_sent_out</span> <span class="p">(</span> <span class="n">engine</span> <span class="o">:</span> <span class="n">fix_engine_state</span> <span class="p">)</span> <span class="o">=</span>
 <span class="k">let</span> <span class="n">engine'</span> <span class="o">=</span> <span class="n">one_step</span> <span class="p">(</span> <span class="n">engine</span> <span class="p">)</span> <span class="k">in</span>
  <span class="p">(</span> <span class="n">is_int_message_valid</span> <span class="p">(</span> <span class="n">engine</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
  <span class="n">is_state_valid</span> <span class="p">(</span> <span class="n">engine</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
  <span class="n">engine</span><span class="o">.</span><span class="n">fe_curr_status</span> <span class="o">=</span> <span class="nc">Normal</span> <span class="o">&amp;&amp;</span> 
  <span class="n">engine</span><span class="o">.</span><span class="n">fe_curr_mode</span> <span class="o">=</span> <span class="nc">ActiveSession</span> <span class="o">&amp;&amp;</span> 
  <span class="n">no_heartbeats_received</span> <span class="p">(</span> <span class="n">engine</span><span class="o">.</span><span class="n">incoming_int_msg</span><span class="o">,</span>
                            <span class="n">engine</span><span class="o">.</span><span class="n">fe_last_data_received</span><span class="o">,</span>
                            <span class="n">engine</span><span class="o">.</span><span class="n">fe_heartbeat_interval</span><span class="o">,</span>
                            <span class="n">engine</span><span class="o">.</span><span class="n">fe_testreq_interval</span> <span class="p">)</span> <span class="p">)</span>
  <span class="o">==&gt;</span>
  <span class="n">msg_is_test_request</span> <span class="p">(</span> <span class="n">engine'</span><span class="o">.</span><span class="n">outgoing_fix_msg</span> <span class="p">)</span>
<span class="p">;;</span></code></pre></figure>

<h3 id="heartbeat-vg4">Heartbeat VG.4</h3>

<p>“If there is still no Heartbeat message received after (HeartBtInt + “some reasonable transmission time”) seconds then the connection should be considered lost and corrective action be initiated.”</p>

<p>Notes: note sure what ‘corrective action be initiated’ means, here we interpret it as meaning that a logoff message to be sent out, session closed and ‘status’ of the engine state set to <code class="highlighter-rouge">ConnTerminatedWithoutLogoff</code>.</p>

<figure class="highlight"><pre><code class="language-iml" data-lang="iml"><span class="k">let</span> <span class="n">no_heartbeats_received_logoff</span> <span class="p">(</span> <span class="n">m</span><span class="o">,</span> <span class="n">data_sent_out</span><span class="o">,</span> <span class="n">hbeat_interval</span><span class="o">,</span> <span class="n">pad_interval</span> <span class="o">:</span> <span class="n">fix_engine_int_msg</span> <span class="n">option</span> <span class="o">*</span> <span class="n">fix_utctimestamp</span> <span class="o">*</span> <span class="n">fix_duration</span> <span class="o">*</span> <span class="n">fix_duration</span> <span class="p">)</span> <span class="o">=</span>
 <span class="k">match</span> <span class="n">m</span> <span class="k">with</span>
 <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="bp">false</span>
 <span class="o">|</span> <span class="nc">Some</span> <span class="n">mint</span> <span class="o">-&gt;</span> 
 <span class="k">match</span> <span class="n">mint</span> <span class="k">with</span> 
 <span class="o">|</span> <span class="nc">TimeChange</span> <span class="n">tc_data</span> <span class="o">-&gt;</span> 
  <span class="k">let</span> <span class="n">valid_time</span> <span class="o">=</span> <span class="n">utctimestamp_add</span> <span class="p">(</span> <span class="n">data_sent_out</span><span class="o">,</span> <span class="n">hbeat_interval</span> <span class="p">)</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">valid_time_padded</span> <span class="o">=</span> <span class="n">utctimestamp_add</span> <span class="p">(</span> <span class="n">valid_time</span><span class="o">,</span> <span class="n">pad_interval</span> <span class="p">)</span> <span class="k">in</span>
  <span class="n">utctimestamp_greaterThan</span> <span class="p">(</span> <span class="n">tc_data</span><span class="o">,</span> <span class="n">valid_time_padded</span> <span class="p">)</span>
 <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="bp">false</span>
<span class="p">;;</span>

<span class="kr">verify</span> <span class="n">no_response_logoff</span> <span class="p">(</span> <span class="n">engine</span> <span class="o">:</span> <span class="n">fix_engine_state</span> <span class="p">)</span> <span class="o">=</span>
 <span class="k">let</span> <span class="n">engine'</span> <span class="o">=</span> <span class="n">one_step</span> <span class="p">(</span> <span class="n">engine</span> <span class="p">)</span> <span class="k">in</span>
 <span class="p">(</span><span class="n">is_int_message_valid</span> <span class="p">(</span> <span class="n">engine</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
  <span class="n">is_state_valid</span> <span class="p">(</span> <span class="n">engine</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
  <span class="n">engine</span><span class="o">.</span><span class="n">fe_curr_mode</span> <span class="o">=</span> <span class="nc">WaitingForHeartbeat</span> <span class="o">&amp;&amp;</span> 
  <span class="n">no_heartbeats_received</span> <span class="p">(</span> <span class="n">engine</span><span class="o">.</span><span class="n">incoming_int_msg</span><span class="o">,</span> 
                            <span class="n">engine</span><span class="o">.</span><span class="n">fe_last_time_data_sent</span><span class="o">,</span>
                            <span class="n">engine</span><span class="o">.</span><span class="n">fe_heartbeat_interval</span><span class="o">,</span>
                            <span class="n">engine</span><span class="o">.</span><span class="n">fe_testreq_interval</span> <span class="p">)</span> <span class="p">)</span>
  <span class="o">==&gt;</span>
  <span class="p">(</span> <span class="n">engine'</span><span class="o">.</span><span class="n">fe_curr_mode</span> <span class="o">=</span> <span class="nc">NoActiveSession</span> <span class="o">&amp;&amp;</span> 
   <span class="n">engine'</span><span class="o">.</span><span class="n">fe_curr_status</span> <span class="o">=</span> <span class="nc">ConnTerminatedWithoutLogoff</span> <span class="p">)</span>
<span class="p">;;</span></code></pre></figure>

<h3 id="heartbeat-vg5">Heartbeat VG.5</h3>

<p>“If HeartBtInt is set to zero then no regular heartbeat messages will be generated. Note that a test request message can still be sent independent of the value of the <code class="highlighter-rouge">HeartBtInt</code>, which will force a Heartbeat message.”</p>

<p>Notes: We implement ‘test request message can still be sent independent of the value of the HeartBtInt’ as internal message.</p>

<figure class="highlight"><pre><code class="language-iml" data-lang="iml"><span class="k">let</span> <span class="n">field_null</span> <span class="p">(</span> <span class="n">f</span> <span class="o">:</span> <span class="kt">int</span> <span class="n">option</span> <span class="p">)</span> <span class="o">=</span>
 <span class="k">match</span> <span class="n">f</span> <span class="k">with</span> 
 <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="bp">true</span>
 <span class="o">|</span> <span class="nc">Some</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
<span class="p">;;</span>

<span class="k">let</span> <span class="n">hbeat_interval_null</span> <span class="p">(</span> <span class="n">interval</span> <span class="o">:</span> <span class="n">fix_duration</span> <span class="p">)</span> <span class="o">=</span>
 <span class="n">field_null</span> <span class="p">(</span> <span class="n">interval</span><span class="o">.</span><span class="n">dur_years</span> <span class="p">)</span>   <span class="o">&amp;&amp;</span>
 <span class="n">field_null</span> <span class="p">(</span> <span class="n">interval</span><span class="o">.</span><span class="n">dur_months</span> <span class="p">)</span>  <span class="o">&amp;&amp;</span> 
 <span class="n">field_null</span> <span class="p">(</span> <span class="n">interval</span><span class="o">.</span><span class="n">dur_days</span> <span class="p">)</span>    <span class="o">&amp;&amp;</span> 
 <span class="n">field_null</span> <span class="p">(</span> <span class="n">interval</span><span class="o">.</span><span class="n">dur_hours</span> <span class="p">)</span>   <span class="o">&amp;&amp;</span>
 <span class="n">field_null</span> <span class="p">(</span> <span class="n">interval</span><span class="o">.</span><span class="n">dur_minutes</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
 <span class="n">field_null</span> <span class="p">(</span> <span class="n">interval</span><span class="o">.</span><span class="n">dur_seconds</span> <span class="p">)</span>
<span class="p">;;</span>

<span class="k">let</span> <span class="n">hbeat_sent_if_no_data_received_new</span> <span class="p">(</span> <span class="n">engine</span> <span class="o">:</span> <span class="n">fix_engine_state</span> <span class="p">)</span> <span class="o">=</span>
 <span class="k">let</span> <span class="n">engine'</span> <span class="o">=</span> <span class="n">one_step</span> <span class="p">(</span> <span class="n">engine</span> <span class="p">)</span> <span class="k">in</span> 
 <span class="p">(</span> <span class="n">engine</span><span class="o">.</span><span class="n">fe_curr_mode</span> <span class="o">=</span> <span class="nc">ActiveSession</span> <span class="o">&amp;&amp;</span> 
  <span class="n">is_valid_utctimestamp</span> <span class="p">(</span> <span class="n">engine</span><span class="o">.</span><span class="n">fe_last_data_received</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> 
  <span class="n">is_int_message_valid</span> <span class="p">(</span> <span class="n">engine</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">is_state_valid</span> <span class="p">(</span> <span class="n">engine</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> 
  <span class="n">time_update_received</span> <span class="p">(</span> <span class="n">engine</span><span class="o">.</span><span class="n">incoming_int_msg</span><span class="o">,</span> <span class="n">engine</span><span class="o">.</span><span class="n">fe_last_data_received</span><span class="o">,</span> <span class="n">engine</span><span class="o">.</span><span class="n">fe_heartbeat_interval</span> <span class="p">)</span> <span class="p">)</span>
 <span class="o">==&gt;</span> <span class="n">outbound_msg_heartbeat</span> <span class="p">(</span> <span class="n">engine'</span><span class="o">.</span><span class="n">outgoing_fix_msg</span> <span class="p">)</span>
<span class="p">;;</span></code></pre></figure>

<h3 id="heartbeat-vg6">Heartbeat VG.6</h3>

<p>“Heartbeats issued as the result of <code class="highlighter-rouge">Test Request</code> must contain the <code class="highlighter-rouge">TestReqID</code> transmitted in the <code class="highlighter-rouge">Test Request</code> message. This is useful to verify that the Heartbeat is the result of the <code class="highlighter-rouge">Test Request</code> and not as the result of a regular timeout.”</p>

<p>Note: that the sequence number of the <code class="highlighter-rouge">TestRequest</code> message must be correct so that the state does not transition into <code class="highlighter-rouge">Recovery</code>.</p>

<figure class="highlight"><pre><code class="language-iml" data-lang="iml"><span class="k">let</span> <span class="n">msg_is_test_request_id</span> <span class="p">(</span> <span class="n">m</span><span class="o">,</span> <span class="n">tr_id</span><span class="o">,</span> <span class="n">seq_num</span> <span class="o">:</span> <span class="n">full_top_level_msg</span> <span class="n">option</span> <span class="o">*</span> <span class="kt">int</span> <span class="o">*</span> <span class="kt">int</span> <span class="p">)</span> <span class="o">=</span>
 <span class="k">match</span> <span class="n">m</span> <span class="k">with</span> 
 <span class="o">|</span> <span class="nc">None</span>  <span class="o">-&gt;</span> <span class="bp">false</span>
 <span class="o">|</span> <span class="nc">Some</span> <span class="n">msg</span> <span class="o">-&gt;</span>
 <span class="k">match</span> <span class="n">msg</span> <span class="k">with</span>
 <span class="o">|</span> <span class="nc">ValidMsg</span> <span class="n">vmsg</span> <span class="o">-&gt;</span> <span class="n">seq_num</span> <span class="o">=</span> <span class="n">vmsg</span><span class="o">.</span><span class="n">full_msg_header</span><span class="o">.</span><span class="n">h_msg_seq_num</span> <span class="o">&amp;&amp;</span> <span class="p">(</span>
  <span class="k">match</span> <span class="n">vmsg</span><span class="o">.</span><span class="n">full_msg_data</span> <span class="k">with</span> 
  <span class="o">|</span> <span class="nc">Full_FIX_Admin_Msg</span> <span class="n">admin_msg</span>  <span class="o">-&gt;</span> <span class="p">(</span>
   <span class="k">match</span> <span class="n">admin_msg</span> <span class="k">with</span> 
   <span class="o">|</span> <span class="nc">Full_Msg_Test_Request</span> <span class="n">data</span> <span class="o">-&gt;</span> <span class="n">data</span><span class="o">.</span><span class="n">test_req_id</span> <span class="o">=</span> <span class="n">tr_id</span>
   <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="bp">false</span>
  <span class="p">)</span>
  <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="bp">false</span>
 <span class="p">)</span>
 <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="bp">false</span>
<span class="p">;;</span>

<span class="k">let</span> <span class="n">correct_hbeat_sent</span> <span class="p">(</span> <span class="n">m</span><span class="o">,</span> <span class="n">tr_id</span> <span class="o">:</span> <span class="n">full_top_level_msg</span> <span class="n">option</span> <span class="o">*</span> <span class="kt">int</span> <span class="p">)</span> <span class="o">=</span>
 <span class="k">match</span> <span class="n">m</span> <span class="k">with</span>
 <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="bp">false</span>
 <span class="o">|</span> <span class="nc">Some</span> <span class="n">msg</span> <span class="o">-&gt;</span>
   <span class="k">match</span> <span class="n">msg</span> <span class="k">with</span> 
   <span class="o">|</span> <span class="nc">ValidMsg</span> <span class="n">vmsg</span> <span class="o">-&gt;</span> <span class="p">(</span>
    <span class="k">match</span> <span class="n">vmsg</span><span class="o">.</span><span class="n">full_msg_data</span> <span class="k">with</span> 
    <span class="o">|</span> <span class="nc">Full_FIX_Admin_Msg</span> <span class="n">admin_msg</span>  <span class="o">-&gt;</span> <span class="p">(</span>
     <span class="k">match</span> <span class="n">admin_msg</span> <span class="k">with</span> 
     <span class="o">|</span> <span class="nc">Full_Msg_Hearbeat</span> <span class="n">data</span> <span class="o">-&gt;</span>  <span class="p">(</span>
      <span class="k">match</span> <span class="n">data</span><span class="o">.</span><span class="n">hb_test_req_id</span> <span class="k">with</span> 
      <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="bp">false</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">tr_id</span>
     <span class="p">)</span>
    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="bp">false</span>
   <span class="p">)</span>
  <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="bp">false</span>
 <span class="p">)</span>
 <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="bp">false</span>
<span class="p">;;</span>

<span class="kr">verify</span> <span class="n">heartbeat_has_correct_id</span> <span class="p">(</span> <span class="n">test_req_id</span><span class="o">,</span> <span class="n">engine</span> <span class="o">:</span> <span class="kt">int</span> <span class="o">*</span> <span class="n">fix_engine_state</span> <span class="p">)</span> <span class="o">=</span>
 <span class="k">let</span> <span class="n">engine'</span> <span class="o">=</span> <span class="n">one_step</span> <span class="p">(</span> <span class="n">engine</span> <span class="p">)</span> <span class="k">in</span> 
 <span class="p">(</span> <span class="n">test_req_id</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> 
   <span class="n">engine</span><span class="o">.</span><span class="n">incoming_int_msg</span> <span class="o">=</span> <span class="nc">None</span> <span class="o">&amp;&amp;</span> 
   <span class="n">engine</span><span class="o">.</span><span class="n">fe_curr_mode</span> <span class="o">=</span> <span class="nc">ActiveSession</span> <span class="o">&amp;&amp;</span> 
   <span class="n">engine</span><span class="o">.</span><span class="n">fe_application_up</span> <span class="o">&amp;&amp;</span> 
   <span class="n">msg_is_test_request_id</span> <span class="p">(</span> <span class="n">engine</span><span class="o">.</span><span class="n">incoming_fix_msg</span><span class="o">,</span> <span class="n">test_req_id</span><span class="o">,</span> <span class="n">engine</span><span class="o">.</span><span class="n">incoming_seq_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">)</span>
    <span class="o">==&gt;</span> <span class="n">correct_hbeat_sent</span> <span class="p">(</span> <span class="n">engine'</span><span class="o">.</span><span class="n">outgoing_fix_msg</span><span class="o">,</span> <span class="n">test_req_id</span> <span class="p">)</span>
<span class="p">;;</span></code></pre></figure>
