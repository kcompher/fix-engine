<h3 id="base-vg1">Base VG.1</h3>

<blockquote>
  <p><em>When in ActiveSession (normal mode) and receiving a non grabled and non session-level</em>
<em>rejected message and the application is down. Such message would be sent back with a</em>
<em>Business Reject.</em></p>
</blockquote>

<figure class="highlight"><pre><code class="language-ocaml" data-lang="ocaml"><span class="k">let</span> <span class="n">msg_is_biz_reject</span> <span class="o">=</span> <span class="k">function</span>  <span class="o">|</span> <span class="nc">Some</span> <span class="p">(</span><span class="nc">ValidMsg</span> <span class="n">msg_data</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="k">begin</span> <span class="k">match</span> <span class="n">msg_data</span><span class="o">.</span><span class="n">full_msg_data</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">Full_FIX_Admin_Msg</span> <span class="p">(</span><span class="nc">Full_Msg_Business_Reject</span> <span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">true</span>
      <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="bp">false</span>
    <span class="k">end</span>
  <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="bp">false</span>
<span class="p">;;</span>

<span class="k">let</span> <span class="n">msg_is_valid</span> <span class="o">=</span> <span class="k">function</span>
  <span class="o">|</span> <span class="nc">Some</span> <span class="p">(</span><span class="nc">ValidMsg</span> <span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">true</span>
  <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="bp">false</span>
<span class="p">;;</span>

<span class="n">verify</span> <span class="n">app_down_get_biz_reject</span> <span class="p">(</span> <span class="n">state</span> <span class="o">:</span> <span class="n">fix_engine_state</span> <span class="p">)</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">incoming_biz_rejected</span> <span class="o">=</span> <span class="n">msg_is_valid</span> <span class="p">(</span> <span class="n">state</span><span class="o">.</span><span class="n">incoming_fix_msg</span> <span class="p">)</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">no_incoming_msgs</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">incoming_int_msg</span> <span class="o">=</span> <span class="nc">None</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">state'</span> <span class="o">=</span> <span class="n">one_step</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">result_biz_reject</span> <span class="o">=</span> <span class="n">msg_is_biz_reject</span> <span class="p">(</span> <span class="n">state'</span><span class="o">.</span><span class="n">outgoing_fix_msg</span> <span class="p">)</span> <span class="k">in</span>
  <span class="p">(</span> <span class="n">state</span><span class="o">.</span><span class="n">fe_cache</span> <span class="o">=</span> <span class="bp">[]</span>
    <span class="o">&amp;&amp;</span> <span class="n">incoming_biz_rejected</span> <span class="o">&amp;&amp;</span> <span class="n">not</span> <span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">fe_application_up</span><span class="p">)</span>
    <span class="o">&amp;&amp;</span> <span class="n">state</span><span class="o">.</span><span class="n">fe_curr_mode</span> <span class="o">=</span> <span class="nc">ActiveSession</span> <span class="o">&amp;&amp;</span> <span class="n">no_incoming_msgs</span> <span class="p">)</span>
  <span class="o">==&gt;</span>
  <span class="n">result_biz_reject</span>
<span class="p">;;</span></code></pre></figure>

<h3 id="base-vg2">Base VG.2</h3>

<p>From Vol 2. Page 9:</p>
<blockquote>
  <p><em>In *ALL</em> cases except the Sequence Reset - message, the FIX session*
<em>should be terminated if the incoming sequence number is less than expected and the</em>
<em>PossDupFlag is not set. A Logout message with some descriptive text should be sent to the</em>
<em>other side before closing the session.</em></p>
</blockquote>

<figure class="highlight"><pre><code class="language-ocaml" data-lang="ocaml"><span class="k">let</span> <span class="n">poss_dup_flag_not_set</span> <span class="p">(</span> <span class="n">flag</span> <span class="o">:</span> <span class="kt">bool</span> <span class="n">option</span> <span class="p">)</span> <span class="o">=</span>
  <span class="n">flag</span> <span class="o">=</span> <span class="nc">None</span>
<span class="p">;;</span>

<span class="k">let</span> <span class="n">incoming_msg_not_valid</span> <span class="p">(</span> <span class="n">msg</span><span class="o">,</span> <span class="n">state_inc_seq_num</span> <span class="o">:</span> <span class="n">full_top_level_msg</span> <span class="n">option</span> <span class="o">*</span> <span class="kt">int</span> <span class="p">)</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">msg</span> <span class="k">with</span>
  <span class="o">|</span> <span class="nc">Some</span> <span class="p">(</span><span class="nc">ValidMsg</span> <span class="n">vmsg</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="k">let</span> <span class="n">seq_num_incorrect</span> <span class="o">=</span> <span class="n">vmsg</span><span class="o">.</span><span class="n">full_msg_header</span><span class="o">.</span><span class="n">h_msg_seq_num</span> <span class="o">&lt;</span> <span class="n">state_inc_seq_num</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">msg_is_seq_reset</span> <span class="o">=</span>
      <span class="k">begin</span> <span class="k">match</span> <span class="n">vmsg</span><span class="o">.</span><span class="n">full_msg_data</span> <span class="k">with</span>
        <span class="o">|</span> <span class="nc">Full_FIX_Admin_Msg</span> <span class="p">(</span><span class="nc">Full_Msg_Sequence_Reset</span> <span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">true</span>
        <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="bp">false</span>
      <span class="k">end</span>
    <span class="k">in</span>
    <span class="p">(</span><span class="n">seq_num_incorrect</span> <span class="o">&amp;&amp;</span> <span class="n">msg_is_seq_reset</span>
     <span class="o">&amp;&amp;</span> <span class="n">poss_dup_flag_not_set</span> <span class="p">(</span> <span class="n">vmsg</span><span class="o">.</span><span class="n">full_msg_header</span><span class="o">.</span><span class="n">h_poss_dup_flag</span> <span class="p">))</span>
  <span class="o">|</span> <span class="n">_</span>   <span class="o">-&gt;</span> <span class="bp">false</span>
<span class="p">;;</span>

<span class="k">let</span> <span class="n">msg_is_logout</span> <span class="o">=</span> <span class="k">function</span>
  <span class="o">|</span> <span class="nc">Some</span> <span class="p">(</span><span class="nc">ValidMsg</span> <span class="n">vmsg</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="k">begin</span> <span class="k">match</span> <span class="n">vmsg</span><span class="o">.</span><span class="n">full_msg_data</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">Full_FIX_Admin_Msg</span> <span class="p">(</span><span class="nc">Full_Msg_Logoff</span> <span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">true</span>
      <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="bp">false</span>
    <span class="k">end</span>
  <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="bp">false</span>
<span class="p">;;</span>

<span class="n">verify</span> <span class="n">less_seq_num_logout</span> <span class="p">(</span> <span class="n">state</span> <span class="o">:</span> <span class="n">fix_engine_state</span> <span class="p">)</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">no_incoming_int_msgs</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">incoming_int_msg</span> <span class="o">=</span> <span class="nc">None</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">state_good</span> <span class="o">=</span> <span class="n">not</span> <span class="p">(</span> <span class="n">state</span><span class="o">.</span><span class="n">fe_application_up</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="n">state</span><span class="o">.</span><span class="n">fe_curr_mode</span> <span class="o">=</span> <span class="nc">ActiveSession</span> <span class="p">)</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">state'</span> <span class="o">=</span> <span class="n">one_step</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="k">in</span>
  <span class="p">(</span> <span class="n">state</span><span class="o">.</span><span class="n">fe_application_up</span> <span class="o">&amp;&amp;</span> <span class="n">no_incoming_int_msgs</span> <span class="o">&amp;&amp;</span> <span class="n">state_good</span> <span class="o">&amp;&amp;</span> <span class="n">state</span><span class="o">.</span><span class="n">fe_cache</span> <span class="o">=</span> <span class="bp">[]</span> <span class="o">&amp;&amp;</span>
    <span class="n">incoming_msg_not_valid</span> <span class="p">(</span> <span class="n">state</span><span class="o">.</span><span class="n">incoming_fix_msg</span><span class="o">,</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">)</span>
  <span class="o">==&gt;</span> <span class="n">msg_is_logout</span> <span class="p">(</span> <span class="n">state'</span><span class="o">.</span><span class="n">outgoing_fix_msg</span> <span class="p">)</span>
<span class="p">;;</span></code></pre></figure>

<h3 id="base-vg3">Base VG.3</h3>

<blockquote>
  <p><em>Messages that are garbled will be ignored (sequence counter will not be incremented).</em></p>
</blockquote>

<figure class="highlight"><pre><code class="language-ocaml" data-lang="ocaml"><span class="k">let</span> <span class="n">incoming_msg_garbled</span> <span class="o">=</span> <span class="k">function</span>
  <span class="o">|</span> <span class="nc">Some</span> <span class="p">(</span><span class="nc">Garbled</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">true</span>
  <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="bp">false</span>
<span class="p">;;</span>

<span class="n">verify</span> <span class="n">garbled_are_ignored</span> <span class="p">(</span> <span class="n">state</span> <span class="o">:</span> <span class="n">fix_engine_state</span> <span class="p">)</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">state'</span> <span class="o">=</span> <span class="n">one_step</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">msg_ignored</span> <span class="o">=</span> <span class="p">(</span> <span class="n">state'</span> <span class="o">=</span>  <span class="p">{</span> <span class="n">state</span> <span class="k">with</span> <span class="n">incoming_fix_msg</span> <span class="o">=</span> <span class="nc">None</span> <span class="p">}</span> <span class="p">)</span> <span class="k">in</span> 
  <span class="k">let</span> <span class="n">no_internal_msgs</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">incoming_int_msg</span> <span class="o">=</span> <span class="nc">None</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">no_cache_replay_or_retransmit</span> <span class="o">=</span> <span class="n">not</span> <span class="p">(</span> <span class="n">state</span><span class="o">.</span><span class="n">fe_curr_mode</span> <span class="o">=</span> <span class="nc">CacheReplay</span> <span class="o">||</span> <span class="n">state</span><span class="o">.</span><span class="n">fe_curr_mode</span> <span class="o">=</span> <span class="nc">Retransmit</span> <span class="p">)</span> <span class="k">in</span>
  <span class="p">(</span> <span class="n">incoming_msg_garbled</span> <span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">incoming_fix_msg</span><span class="p">)</span>
    <span class="o">&amp;&amp;</span> <span class="n">no_cache_replay_or_retransmit</span>
    <span class="o">&amp;&amp;</span> <span class="n">no_internal_msgs</span> <span class="p">)</span>
  <span class="o">==&gt;</span> <span class="n">msg_ignored</span>
<span class="p">;;</span></code></pre></figure>

<h3 id="base-vg4">Base VG.4</h3>

<blockquote>
  <p><em>Session rejected messages are rejected with the right reason and counter is incremented.</em></p>
</blockquote>

<figure class="highlight"><pre><code class="language-ocaml" data-lang="ocaml"><span class="k">let</span> <span class="n">incoming_msg_session_reject</span> <span class="o">=</span> <span class="k">function</span>
  <span class="o">|</span> <span class="nc">Some</span> <span class="p">(</span><span class="nc">SessionRejectedMsg</span> <span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">true</span>
  <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="bp">false</span>
<span class="p">;;</span>

<span class="k">let</span> <span class="n">msg_is_reject</span> <span class="o">=</span> <span class="k">function</span>
  <span class="o">|</span> <span class="nc">Some</span> <span class="p">(</span><span class="nc">ValidMsg</span> <span class="n">vmsg</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="k">begin</span> <span class="k">match</span> <span class="n">vmsg</span><span class="o">.</span><span class="n">full_msg_data</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">Full_FIX_Admin_Msg</span> <span class="p">(</span><span class="nc">Full_Msg_Reject</span> <span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">true</span>
      <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="bp">false</span>
    <span class="k">end</span>
  <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="bp">false</span>
<span class="p">;;</span>

<span class="c">(** Note that it's important to remember that a message may only be rejected if we're in ActiveSession state. 
    It would be otherwise ignore (if in NoActiveSession state) or not processed if the engine is in CacheReplay or 
    Retransmit modes. *)</span>
<span class="n">verify</span> <span class="n">session_rejects_are_rejected</span> <span class="p">(</span> <span class="n">state</span> <span class="o">:</span> <span class="n">fix_engine_state</span> <span class="p">)</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">no_incoming_int_msgs</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">incoming_int_msg</span> <span class="o">=</span> <span class="nc">None</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">incoming_rejected</span> <span class="o">=</span> <span class="n">incoming_msg_session_reject</span> <span class="p">(</span> <span class="n">state</span><span class="o">.</span><span class="n">incoming_fix_msg</span> <span class="p">)</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">state'</span> <span class="o">=</span> <span class="n">one_step</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">msg_rejected</span> <span class="o">=</span> <span class="n">msg_is_reject</span> <span class="p">(</span> <span class="n">state'</span><span class="o">.</span><span class="n">outgoing_fix_msg</span> <span class="p">)</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">seq_num_updated</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span> <span class="n">state</span><span class="o">.</span><span class="n">outgoing_seq_num</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">)</span> <span class="o">=</span> <span class="n">state'</span><span class="o">.</span><span class="n">outgoing_seq_num</span> <span class="p">)</span> <span class="k">in</span>
  <span class="p">(</span> <span class="n">no_incoming_int_msgs</span> <span class="o">&amp;&amp;</span> <span class="n">incoming_rejected</span> <span class="o">&amp;&amp;</span> <span class="n">state</span><span class="o">.</span><span class="n">fe_curr_mode</span> <span class="o">=</span> <span class="nc">ActiveSession</span><span class="p">)</span>
  <span class="o">==&gt;</span>
  <span class="p">(</span> <span class="n">msg_rejected</span> <span class="o">&amp;&amp;</span> <span class="n">seq_num_updated</span> <span class="p">)</span>
<span class="p">;;</span></code></pre></figure>
