<p>This section describes verification goals for Logon messages.</p>
<h3 id="logon-vg1">Logon VG.1</h3>

<p>“The logon message must be the first message sent by the application requesting to initiate a FIX session.”</p>

<p>Note: we augment this with requirement that the engine correctly sets the acceptor/initiator flag.</p>

<figure class="highlight"><pre><code class="language-ocaml" data-lang="ocaml"><span class="k">let</span> <span class="n">incoming_int_create_session</span> <span class="p">(</span> <span class="n">m</span><span class="o">,</span> <span class="n">targetID</span> <span class="o">:</span> <span class="n">fix_engine_int_msg</span> <span class="n">option</span> <span class="o">*</span> <span class="kt">int</span> <span class="p">)</span> <span class="o">=</span>
    <span class="k">match</span> <span class="n">m</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nc">None</span>      <span class="o">-&gt;</span> <span class="bp">false</span>
    <span class="o">|</span> <span class="nc">Some</span> <span class="n">msg</span>  <span class="o">-&gt;</span>
    <span class="k">match</span> <span class="n">msg</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nc">CreateSession</span> <span class="n">data</span>    <span class="o">-&gt;</span> <span class="n">data</span><span class="o">.</span><span class="n">dest_comp_id</span> <span class="o">=</span> <span class="n">targetID</span>
    <span class="o">|</span> <span class="n">_</span>                     <span class="o">-&gt;</span> <span class="bp">false</span>
<span class="p">;;</span>

<span class="k">let</span> <span class="n">state_is_init</span> <span class="p">(</span> <span class="n">engine</span> <span class="o">:</span> <span class="n">fix_engine_state</span> <span class="p">)</span> <span class="o">=</span>
    <span class="n">engine</span><span class="o">.</span><span class="n">incoming_seq_num</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
    <span class="n">engine</span><span class="o">.</span><span class="n">outgoing_seq_num</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
    <span class="n">engine</span><span class="o">.</span><span class="n">fe_initiator</span> <span class="o">=</span> <span class="nc">None</span> <span class="o">&amp;&amp;</span>
    <span class="n">engine</span><span class="o">.</span><span class="n">fe_curr_mode</span> <span class="o">=</span> <span class="nc">NoActiveSession</span> <span class="o">&amp;&amp;</span>
    <span class="n">engine</span><span class="o">.</span><span class="n">fe_curr_status</span> <span class="o">=</span> <span class="nc">Normal</span> <span class="o">&amp;&amp;</span>
    <span class="n">engine</span><span class="o">.</span><span class="n">fe_history</span> <span class="o">=</span> <span class="bp">[]</span> <span class="o">&amp;&amp;</span>
    <span class="n">engine</span><span class="o">.</span><span class="n">fe_cache</span> <span class="o">=</span> <span class="bp">[]</span>
<span class="p">;;</span>

<span class="k">let</span> <span class="n">outbound_msg_logon</span> <span class="p">(</span> <span class="n">m</span><span class="o">,</span> <span class="n">targetID</span> <span class="o">:</span> <span class="n">full_top_level_msg</span> <span class="n">option</span> <span class="o">*</span> <span class="kt">int</span> <span class="p">)</span> <span class="o">=</span>
    <span class="k">match</span> <span class="n">m</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nc">None</span>      <span class="o">-&gt;</span> <span class="bp">false</span>
    <span class="o">|</span> <span class="nc">Some</span> <span class="n">msg</span>  <span class="o">-&gt;</span>
    <span class="k">match</span> <span class="n">msg</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nc">ValidMsg</span> <span class="n">vmsg</span> <span class="o">-&gt;</span> <span class="p">(</span>
    <span class="k">let</span> <span class="n">correct_target_id</span> <span class="o">=</span> <span class="n">vmsg</span><span class="o">.</span><span class="n">full_msg_header</span><span class="o">.</span><span class="n">h_target_comp_id</span> <span class="o">=</span> <span class="n">targetID</span> <span class="k">in</span>
    <span class="k">match</span> <span class="n">vmsg</span><span class="o">.</span><span class="n">full_msg_data</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nc">Full_FIX_App_Msg</span> <span class="n">_</span>        <span class="o">-&gt;</span> <span class="bp">false</span>
    <span class="o">|</span> <span class="nc">Full_FIX_Admin_Msg</span> <span class="n">amsg</span>   <span class="o">-&gt;</span>
    <span class="k">match</span> <span class="n">amsg</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nc">Full_Msg_Logon</span> <span class="n">_</span>          <span class="o">-&gt;</span> <span class="n">correct_target_id</span>
    <span class="o">|</span> <span class="n">_</span>                         <span class="o">-&gt;</span> <span class="bp">false</span>
    <span class="p">)</span>
    <span class="o">|</span> <span class="n">_</span>             <span class="o">-&gt;</span> <span class="bp">false</span>
<span class="p">;;</span>

<span class="n">verify</span> <span class="n">logon_msg_is_first</span> <span class="p">(</span> <span class="n">engine</span><span class="o">,</span> <span class="n">targetID</span> <span class="o">:</span> <span class="n">fix_engine_state</span> <span class="o">*</span> <span class="kt">int</span> <span class="p">)</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">engine'</span> <span class="o">=</span> <span class="n">one_step</span> <span class="p">(</span> <span class="n">engine</span> <span class="p">)</span> <span class="k">in</span>
    <span class="p">(</span> <span class="n">state_is_init</span> <span class="p">(</span> <span class="n">engine</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
    <span class="n">incoming_int_create_session</span> <span class="p">(</span> <span class="n">engine</span><span class="o">.</span><span class="n">incoming_int_msg</span><span class="o">,</span> <span class="n">targetID</span> <span class="p">)</span> <span class="p">)</span> <span class="o">==&gt;</span>
     <span class="p">(</span> <span class="n">outbound_msg_logon</span> <span class="p">(</span> <span class="n">engine'</span><span class="o">.</span><span class="n">outgoing_fix_msg</span><span class="o">,</span> <span class="n">targetID</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
     <span class="n">engine'</span><span class="o">.</span><span class="n">fe_curr_mode</span> <span class="o">=</span> <span class="nc">LogonInitiated</span> <span class="o">&amp;&amp;</span>
     <span class="n">engine'</span><span class="o">.</span><span class="n">fe_initiator</span> <span class="o">=</span> <span class="nc">Some</span> <span class="bp">true</span><span class="p">)</span>
<span class="p">;;</span></code></pre></figure>

<h3 id="logon-vg2">Logon VG.2</h3>

<p>“The session acceptor must be prepared to immediately begin processing messages after receipt of the Logon. The session initiator can choose to begin transmission of FIX messages before receipt of the confirmation Logon, however it is recommended that normal message delivery wait until after the return Logon is received to accommodate encryption key negotiation.”</p>

<figure class="highlight"><pre><code class="language-ocaml" data-lang="ocaml"><span class="c">(* Logon VG2.1 *)</span>
<span class="k">let</span> <span class="n">waiting_for_logon_ack</span> <span class="p">(</span> <span class="n">engine</span> <span class="o">:</span> <span class="n">fix_engine_state</span> <span class="p">)</span> <span class="o">=</span>
    <span class="n">engine</span><span class="o">.</span><span class="n">fe_curr_mode</span> <span class="o">=</span> <span class="nc">LogonInitiated</span>
<span class="p">;;</span>

<span class="k">let</span> <span class="n">int_app_msg_exists</span> <span class="p">(</span> <span class="n">m</span> <span class="o">:</span> <span class="n">fix_engine_int_msg</span> <span class="n">option</span> <span class="p">)</span> <span class="o">=</span>
    <span class="k">match</span> <span class="n">m</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nc">None</span>      <span class="o">-&gt;</span> <span class="bp">false</span>
    <span class="o">|</span> <span class="nc">Some</span> <span class="n">_</span>    <span class="o">-&gt;</span> <span class="bp">true</span>
<span class="p">;;</span>

<span class="k">let</span> <span class="n">no_msg_sent_until_logon_acked</span> <span class="p">(</span> <span class="n">engine</span> <span class="o">:</span> <span class="n">fix_engine_state</span> <span class="p">)</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">engine'</span> <span class="o">=</span> <span class="n">one_step</span> <span class="p">(</span> <span class="n">engine</span> <span class="p">)</span> <span class="k">in</span>
    <span class="p">(</span> <span class="n">engine</span><span class="o">.</span><span class="n">fe_curr_mode</span> <span class="o">=</span> <span class="nc">LogonInitiated</span> <span class="o">&amp;&amp;</span> <span class="n">int_app_msg_exists</span> <span class="p">(</span> <span class="n">engine'</span> <span class="p">))</span>
    <span class="o">==&gt;</span>
    <span class="p">(</span> <span class="n">engine'</span><span class="o">.</span><span class="n">outgoing_fix_msg</span> <span class="o">=</span> <span class="nc">None</span> <span class="p">)</span>
<span class="p">;;</span>

<span class="c">(* Logon VG2.2 *)</span>
<span class="k">let</span> <span class="n">incoming_logon_ack</span> <span class="p">(</span> <span class="n">m</span><span class="o">,</span> <span class="n">self_comp_id</span> <span class="o">:</span> <span class="n">full_top_level_msg</span> <span class="n">option</span> <span class="o">*</span> <span class="kt">int</span> <span class="p">)</span> <span class="o">=</span>
    <span class="k">match</span> <span class="n">m</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="bp">false</span>
    <span class="o">|</span> <span class="nc">Some</span> <span class="n">msg</span> <span class="o">-&gt;</span>
    <span class="k">match</span> <span class="n">msg</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nc">ValidMsg</span> <span class="n">vmsg</span> <span class="o">-&gt;</span> <span class="p">(</span>
        <span class="k">let</span> <span class="n">valid_header</span> <span class="o">=</span> <span class="n">vmsg</span><span class="o">.</span><span class="n">full_msg_header</span><span class="o">.</span><span class="n">h_target_comp_id</span> <span class="o">=</span> <span class="n">self_comp_id</span> <span class="k">in</span>
        <span class="k">match</span> <span class="n">vmsg</span><span class="o">.</span><span class="n">full_msg_data</span> <span class="k">with</span>
        <span class="o">|</span> <span class="nc">Full_FIX_App_Msg</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="bp">false</span>
        <span class="o">|</span> <span class="nc">Full_FIX_Admin_Msg</span> <span class="n">amsg</span> <span class="o">-&gt;</span> <span class="p">(</span>
            <span class="k">match</span> <span class="n">amsg</span> <span class="k">with</span>
            <span class="o">|</span> <span class="nc">Full_Msg_Logon</span> <span class="n">data</span> <span class="o">-&gt;</span> <span class="n">valid_header</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="bp">false</span>
         <span class="p">)</span>
     <span class="p">)</span>
    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="bp">false</span>
<span class="p">;;</span>

<span class="n">verify</span> <span class="n">receive_logon_ack</span> <span class="p">(</span> <span class="n">engine</span> <span class="o">:</span> <span class="n">fix_engine_state</span> <span class="p">)</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">engine'</span> <span class="o">=</span> <span class="n">one_step</span> <span class="p">(</span> <span class="n">engine</span> <span class="p">)</span> <span class="k">in</span>
    <span class="p">(</span> <span class="n">incoming_logon_ack</span> <span class="p">(</span> <span class="n">engine</span><span class="o">.</span><span class="n">incoming_fix_msg</span><span class="o">,</span> <span class="n">engine</span><span class="o">.</span><span class="n">fe_comp_id</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
        <span class="n">engine</span><span class="o">.</span><span class="n">fe_curr_mode</span> <span class="o">=</span> <span class="nc">LogonInitiated</span> <span class="o">&amp;&amp;</span>
        <span class="n">engine</span><span class="o">.</span><span class="n">fe_cache</span> <span class="o">=</span> <span class="bp">[]</span> <span class="o">&amp;&amp;</span>
        <span class="n">is_state_valid</span> <span class="p">(</span> <span class="n">engine</span> <span class="p">)</span> <span class="p">)</span>
    <span class="o">==&gt;</span>
    <span class="p">(</span> <span class="n">engine'</span><span class="o">.</span><span class="n">fe_curr_mode</span> <span class="o">=</span> <span class="nc">ActiveSession</span> <span class="p">)</span>
<span class="p">;;</span></code></pre></figure>

<h3 id="logon-vg3">Logon VG.3</h3>

<p>“After authentication, the initiator and acceptor must synchronize their messages through interrogation of the <code class="highlighter-rouge">MsgSeqNum</code> field before sending any queued or new messages. A comparison of the <code class="highlighter-rouge">MsgSeqNum</code> in the Logon message to the internally monitored next expected sequence number will indicate any message gaps. Likewise, the initiator can detect gaps by comparing the acknowledgment Logon message’s MsgSeqNum to the next expected value. The section on message recovery later in this document deals with message gap handling.”</p>

<figure class="highlight"><pre><code class="language-ocaml" data-lang="ocaml"><span class="k">let</span> <span class="n">logon_msg_out_of_sequence</span> <span class="p">(</span> <span class="n">m</span> <span class="o">:</span> <span class="n">full_top_level_msg</span> <span class="n">option</span> <span class="p">)</span> <span class="o">=</span>
    <span class="bp">true</span>
<span class="p">;;</span>

<span class="n">verify</span> <span class="n">when_gap_detected_request_is_sent</span> <span class="p">(</span> <span class="n">engine</span> <span class="o">:</span> <span class="n">fix_engine_state</span> <span class="p">)</span> <span class="o">=</span>

    <span class="k">let</span> <span class="n">engine'</span> <span class="o">=</span> <span class="n">one_step</span> <span class="p">(</span> <span class="n">engine</span> <span class="p">)</span> <span class="k">in</span>

    <span class="n">logon_msg_out_of_sequence</span> <span class="p">(</span> <span class="n">engine</span> <span class="p">)</span>
        <span class="o">==&gt;</span>
    <span class="p">(</span> <span class="n">test_request_sent</span> <span class="p">(</span> <span class="n">engine'</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">engine'</span><span class="o">.</span><span class="n">fe_curr_mode</span> <span class="o">=</span> <span class="nc">Recovery</span> <span class="p">)</span>
<span class="p">;;</span></code></pre></figure>

<h3 id="logon-vg4">Logon VG.4</h3>

<p>“If the session acceptor has chosen to change the session encryption key, the session initiator must send a third Logon back to the other side in order to acknowledge the key change request. This also allows the session acceptor to know when the session initiator has started to encrypt using the new session key. Both parties are responsible for infinite loop detection and prevention during this phase of the session.”</p>

<p>Notes: we break up the statement into the following VGs:</p>
<ul>
  <li>4.1 - If a confirmation Logon is received with a different encryption key, then another Logon is sent back with the same key. Also, we increment the ‘fe_num_logons_sent’ counter.</li>
  <li>4.2 - When the engine attempts to send out a Logon message when the count is violated, it would transition into error mode with status change.</li>
</ul>

<figure class="highlight"><pre><code class="language-ocaml" data-lang="ocaml"><span class="k">let</span> <span class="n">received_logon_diff_key</span> <span class="p">(</span> <span class="n">m</span><span class="o">,</span> <span class="n">self_comp_id</span><span class="o">,</span> <span class="n">encrypt_method</span> <span class="o">:</span> <span class="n">full_top_level_msg</span> <span class="n">option</span> <span class="o">*</span> <span class="kt">int</span> <span class="o">*</span> <span class="n">fix_encryption_method</span> <span class="p">)</span> <span class="o">=</span>
    <span class="k">match</span> <span class="n">m</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="bp">true</span>
    <span class="o">|</span> <span class="nc">Some</span> <span class="n">msg</span> <span class="o">-&gt;</span>
    <span class="k">match</span> <span class="n">msg</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nc">ValidMsg</span> <span class="n">vmsg</span> <span class="o">-&gt;</span> <span class="p">(</span>
        <span class="k">let</span> <span class="n">valid_header</span> <span class="o">=</span> <span class="n">vmsg</span><span class="o">.</span><span class="n">full_msg_header</span><span class="o">.</span><span class="n">h_target_comp_id</span> <span class="o">=</span> <span class="n">self_comp_id</span> <span class="k">in</span>
        <span class="k">match</span> <span class="n">vmsg</span><span class="o">.</span><span class="n">full_msg_data</span> <span class="k">with</span>
        <span class="o">|</span> <span class="nc">Full_FIX_App_Msg</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="bp">false</span>
        <span class="o">|</span> <span class="nc">Full_FIX_Admin_Msg</span> <span class="n">amsg</span> <span class="o">-&gt;</span> <span class="p">(</span>
            <span class="k">match</span> <span class="n">amsg</span> <span class="k">with</span>
            <span class="o">|</span> <span class="nc">Full_Msg_Logon</span> <span class="n">data</span> <span class="o">-&gt;</span> <span class="n">valid_header</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="n">data</span><span class="o">.</span><span class="n">ln_encrypt_method</span> <span class="o">=</span> <span class="n">encrypt_method</span> <span class="p">)</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="bp">false</span>
         <span class="p">)</span>
    <span class="p">)</span>
    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="bp">false</span>
<span class="p">;;</span>

<span class="k">let</span> <span class="n">logon_sent_out</span> <span class="p">(</span> <span class="n">m</span><span class="o">,</span> <span class="n">encrypt_method</span> <span class="o">:</span> <span class="n">full_top_level_msg</span> <span class="n">option</span> <span class="o">*</span> <span class="n">fix_encryption_method</span> <span class="p">)</span> <span class="o">=</span>
    <span class="k">match</span> <span class="n">m</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="bp">true</span>
    <span class="o">|</span> <span class="nc">Some</span> <span class="n">msg</span> <span class="o">-&gt;</span>
    <span class="k">match</span> <span class="n">msg</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nc">ValidMsg</span> <span class="n">vmsg</span> <span class="o">-&gt;</span> <span class="p">(</span>
        <span class="k">match</span> <span class="n">vmsg</span><span class="o">.</span><span class="n">full_msg_data</span> <span class="k">with</span>
        <span class="o">|</span> <span class="nc">Full_FIX_App_Msg</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="bp">false</span>
        <span class="o">|</span> <span class="nc">Full_FIX_Admin_Msg</span> <span class="n">amsg</span> <span class="o">-&gt;</span> <span class="p">(</span>
            <span class="k">match</span> <span class="n">amsg</span> <span class="k">with</span>
            <span class="o">|</span> <span class="nc">Full_Msg_Logon</span> <span class="n">data</span> <span class="o">-&gt;</span> <span class="n">data</span><span class="o">.</span><span class="n">ln_encrypt_method</span> <span class="o">=</span> <span class="n">encrypt_method</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="bp">false</span>
         <span class="p">)</span>
    <span class="p">)</span>
    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="bp">false</span>
<span class="p">;;</span>

<span class="c">(** Logon VG.4.1 *)</span>
<span class="n">verify</span> <span class="n">encrypt_key_different_logon_sent</span> <span class="p">(</span> <span class="n">engine</span><span class="o">,</span> <span class="n">new_encrypt_method</span> <span class="o">:</span> <span class="n">fix_engine_state</span> <span class="o">*</span> <span class="n">fix_encryption_method</span> <span class="p">)</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">engine'</span> <span class="o">=</span> <span class="n">one_step</span> <span class="p">(</span> <span class="n">engine</span> <span class="p">)</span> <span class="k">in</span>
    <span class="p">(</span>   <span class="n">engine</span><span class="o">.</span><span class="n">fe_cache</span> <span class="o">=</span> <span class="bp">[]</span> <span class="o">&amp;&amp;</span>
        <span class="n">engine</span><span class="o">.</span><span class="n">fe_curr_mode</span> <span class="o">=</span> <span class="nc">LogonInitiated</span> <span class="o">&amp;&amp;</span>
        <span class="n">engine</span><span class="o">.</span><span class="n">fe_encrypt_method</span> <span class="o">&lt;&gt;</span> <span class="n">new_encrypt_method</span> <span class="o">&amp;&amp;</span>
        <span class="n">received_logon_diff_key</span> <span class="p">(</span> <span class="n">engine</span><span class="o">.</span><span class="n">incoming_fix_msg</span><span class="o">,</span> <span class="n">engine</span><span class="o">.</span><span class="n">fe_comp_id</span><span class="o">,</span> <span class="n">new_encrypt_method</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
        <span class="n">engine</span><span class="o">.</span><span class="n">fe_num_logons_sent</span> <span class="o">&lt;</span> <span class="n">engine</span><span class="o">.</span><span class="n">fe_max_num_logons_sent</span>
    <span class="p">)</span> <span class="o">==&gt;</span> <span class="p">(</span>
        <span class="n">logon_sent_out</span> <span class="p">(</span> <span class="n">engine'</span><span class="o">.</span><span class="n">outgoing_fix_msg</span><span class="o">,</span> <span class="n">new_encrypt_method</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
        <span class="n">engine'</span><span class="o">.</span><span class="n">fe_encrypt_method</span> <span class="o">=</span> <span class="n">new_encrypt_method</span> <span class="o">&amp;&amp;</span>
        <span class="n">engine'</span><span class="o">.</span><span class="n">fe_num_logons_sent</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">engine</span><span class="o">.</span><span class="n">fe_num_logons_sent</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">;;</span>

<span class="c">(** Logon VG.4.2 *)</span>
<span class="n">verify</span> <span class="n">max_num_logons_breached_error</span> <span class="p">(</span> <span class="n">engine</span> <span class="o">:</span> <span class="n">fix_engine_state</span> <span class="p">)</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">engine'</span> <span class="o">=</span> <span class="n">one_step</span> <span class="p">(</span> <span class="n">engine</span> <span class="p">)</span> <span class="k">in</span>
    <span class="p">(</span> <span class="n">received_logon_diff_key</span> <span class="p">(</span> <span class="n">engine</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
        <span class="p">(</span> <span class="n">engine</span><span class="o">.</span><span class="n">fe_num_logons_sent</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">fe_max_num_logons_sent</span> <span class="p">)</span> <span class="p">)</span>
    <span class="o">==&gt;</span>
    <span class="p">(</span> <span class="n">engine'</span><span class="o">.</span><span class="n">fe_curr_mode</span> <span class="o">=</span> <span class="nc">Error</span> <span class="o">&amp;&amp;</span>
        <span class="n">engine'</span><span class="o">.</span><span class="n">fe_curr_status</span> <span class="o">=</span> <span class="nc">MaxNumLogonMsgsViolated</span> <span class="p">)</span>
<span class="p">;;</span></code></pre></figure>

<h3 id="logon-vg5">Logon VG.5</h3>

<blockquote>
  <p><em>“<code class="highlighter-rouge">NextExpectedMsgSeqNum (789)</code> is used as follows:</em>
<em>In its Logon request the session initiator supplies in <code class="highlighter-rouge">NextExpectedMsgSeqNum (789)</code> the value next expected from the session acceptor in MsgSeqNum (34). The outgoing header MsgSeqNum (34) of the Logon request is assigned the next-to-be-assigned sequence number as usual.</em></p>
</blockquote>

<p>The session acceptor validates the Logon request including that NextExpectedMsgSeqNum (789) does not represent a gap. It then constructs its Logon response with NextExpectedMsgSeqNum (789) containing the value next expected from the session initiator in MsgSeqNum (34) having incremented the number above the Logon request if that was the sequence expected. The outgoing header MsgSeqNum (34) is constructed as usual. The session initiator waits to begin sending application messages until it receives the Logon response. When it is received the initiator validates the response including that NextExpectedMsgSeqNum (789) does not represent a gap.</p>

<p>Both sides react to NextExpectedMsgSeqNum (789) from its counterparty thus:</p>
<ul>
  <li>If equal to the next-to-be-assigned sequence, proceed sending new messages beginning with that number.</li>
  <li>If lower than the next-to-be-assigned sequence, ‘recover’ (see ‘Message Recovery’) all messages from the the last message delivered prior to this Logon through the specified <code class="highlighter-rouge">NextExpectedMsgSeqNum (789)</code> sending them in order; then Gap Fill over the sequence number used in Logon and proceed sending newly queued messages with a sequence number one higher than the original Logon.</li>
  <li>If higher than the next-to-be-assigned sequence, send Logout to abort the session.</li>
</ul>

<p>Neither side should generate a ResendRequest based on MsgSeqNum (34) of the incoming Logon message but should expect any gaps to be filled automatically. If a gap is produced by the Logon message MsgSeqNum (34), the receive logic should expect the gap to be filled automatically prior to receiving any messages with sequences above the gap.”</p>

<figure class="highlight"><pre><code class="language-ocaml" data-lang="ocaml"><span class="k">let</span> <span class="n">is_next_expected_msg_seq_num_present</span> <span class="p">(</span> <span class="n">m</span><span class="o">,</span> <span class="n">next_seq_num</span> <span class="o">:</span> <span class="n">full_top_level_msg</span> <span class="n">option</span> <span class="o">*</span> <span class="kt">int</span> <span class="p">)</span> <span class="o">=</span>
    <span class="k">match</span> <span class="n">m</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="bp">true</span>
    <span class="o">|</span> <span class="nc">Some</span> <span class="n">msg</span> <span class="o">-&gt;</span>
    <span class="k">match</span> <span class="n">msg</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nc">ValidMsg</span> <span class="n">vmsg</span> <span class="o">-&gt;</span> <span class="p">(</span>
        <span class="k">match</span> <span class="n">vmsg</span><span class="o">.</span><span class="n">full_msg_data</span> <span class="k">with</span>
        <span class="o">|</span> <span class="nc">Full_FIX_App_Msg</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="bp">false</span>
        <span class="o">|</span> <span class="nc">Full_FIX_Admin_Msg</span> <span class="n">amsg</span> <span class="o">-&gt;</span> <span class="p">(</span>
            <span class="k">match</span> <span class="n">amsg</span> <span class="k">with</span>
            <span class="o">|</span> <span class="nc">Full_Msg_Logon</span> <span class="n">data</span> <span class="o">-&gt;</span>  <span class="p">(</span>
                <span class="k">match</span> <span class="n">data</span><span class="o">.</span><span class="n">ln_next_expected_msg_seq_num</span> <span class="k">with</span>
                <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="bp">false</span>
                <span class="o">|</span> <span class="nc">Some</span> <span class="n">seq_num</span> <span class="o">-&gt;</span> <span class="n">seq_num</span> <span class="o">=</span> <span class="n">next_seq_num</span>
            <span class="p">)</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="bp">false</span>
         <span class="p">)</span>
    <span class="p">)</span>
    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="bp">false</span>
<span class="p">;;</span></code></pre></figure>
